# MQTT

### MQTT（Message Queuing Telemetry Transport，消息队列遥测传输）是一种轻量级、低带宽消耗的发布 / 订阅模式消息传输协议，专为受限网络环境（如低带宽、高延迟、不稳定网络）和资源受限设备（如传感器、嵌入式设备）设计，广泛应用于物联网（IoT）、工业监控、智能家居等场景

### 一、MQTT 的核心特点

### 1.轻量级

- 协议头部极小（最小仅 2 字节），数据传输效率极高，适合带宽有限的场景（如卫星通信、LoRa 等）。
  设备端实现简单，对硬件资源（CPU、内存）要求低，可在单片机等低端设备上运行。

### 2.发布 / 订阅模式

- 采用 “发布者（Publisher）- 代理（Broker）- 订阅者（Subscriber）” 架构，解耦消息的生产者和消费者：
  发布者：产生消息并发送到 Broker，无需知道订阅者的存在。
  订阅者：向 Broker 订阅感兴趣的消息，无需知道发布者的存在。
  Broker：核心中转节点，接收发布者的消息，按规则转发给所有订阅者。
  这种模式避免了设备间直接通信的复杂性（如地址管理、连接维护），支持一对多、多对多通信。

### 3. 灵活的服务质量（QoS）

- 提供 3 种消息交付质量等级，满足不同场景的可靠性需求：
  - QoS 0：最多一次，消息仅发送一次，不确认、不重传。适用于非关键数据（如传感器周期性温湿度上报）。
  - QoS 1：至少一次，消息会重传直到接收者确认（PUBACK），确保消息至少到达一次（可能重复）。适用于重要但可容忍重复的数据（如设备状态更新）。
  - QoS 2：通过四次握手（发布者发送→Broker 确认→订阅者确认→发布者最终确认）确保消息仅到达一次，无重复。适用于关键数据（如支付指令、设备控制命令）。

### 4. 主题（Topic）机制

- 消息通过 “主题” 分类，订阅者通过订阅主题接收消息，类似 “频道” 概念。
  - 主题格式：用斜杠（/）分隔层级，如sensors/temp/room1（房间 1 的温度传感器）、devices/light/客厅（客厅的光照传感器）。
- 通配符支持：
  - 单级通配符（+）：匹配单个层级，如sensors/temp/+ 匹配 sensors/temp/room1、sensors/temp/room2。
  - 多级通配符（#）：匹配多个层级（必须放在末尾），如sensors/# 匹配 sensors/temp/room1、sensors/humidity/room3。

### 二、MQTT 的关键机制

### 1.保留消息（Retained Message）

- 发布者可标记消息为 “保留消息”，Broker 会保存该主题的最新保留消息。当新订阅者订阅该主题时，Broker 会立即将保留消息推送给它，无需等待新消息发布。适用场景：设备刚上线时获取当前状态（如 “当前房间温度是 25℃”）

### 2.遗嘱消息（Last Will and Testament, LWT）

- 设备连接 Broker 时可预设 “遗嘱消息” 和 “遗嘱主题”。若设备异常断开连接（如断电、网络中断），Broker 会自动将遗嘱消息发送到遗嘱主题，通知其他设备该设备离线。适用场景：监控设备在线状态（如 “设备 A 已离线”）。

### 3.连接保活（Keep Alive）

- 设备连接时会设置 “保活时间”（如 60 秒），需在该时间内通过PINGREQ报文向 Broker 发送心跳，Broker 用PINGRESP响应。若超时未收到心跳，Broker 判定设备离线并触发遗嘱消息。

### 三、MQTT 协议基础

- 1.传输层依赖
  - 基于 TCP/IP 协议栈，依赖 TCP 的可靠性（三次握手建立连接、重传机制），确保消息传输的底层稳定性。
- 2.消息结构
  - MQTT 消息由 “固定头部”+“可变头部”+“ payload（消息体）” 组成：
    - 固定头部：包含消息类型（如 CONNECT、PUBLISH）、QoS 等级、保留标志等核心控制信息（最小 2 字节）。
    - 可变头部：根据消息类型附加额外信息（如主题名、消息 ID）。
    - payload：实际传输的业务数据（如 JSON 字符串、二进制数据），长度可选（可为 0）。
- 3.核心消息类型
  - MQTT 定义了 14 种消息类型，关键类型如下：
    - CONNECT：客户端向 Broker 发起连接请求（携带客户端 ID、用户名、密码等）。
    - CONNACK：Broker 对连接请求的响应（成功 / 失败）。
    - PUBLISH：发布者发送消息到 Broker（携带主题、QoS、payload）。
    - SUBSCRIBE：订阅者向 Broker 请求订阅主题（携带主题列表、QoS）。
    - SUBACK：Broker 对订阅请求的确认（返回实际订阅的 QoS）。
    - UNSUBSCRIBE：取消订阅。
    - UNSUBACK：Broker 对取消订阅请求的确认。

### 四、MQTT 的工作流程

- 以 “温度传感器上报数据到监控平台” 为例：

1. 连接：传感器（发布者）和监控平台（订阅者）分别通过CONNECT报文连接到 MQTT Broker，Broker 返回CONNACK确认连接成功。
2. 订阅：监控平台通过SUBSCRIBE报文订阅主题sensors/temp，Broker 用SUBACK确认订阅。
3. 发布：传感器采集温度后，通过PUBLISH报文将数据（如{"temp":25}）发送到主题sensors/temp（QoS 1）。
4. 转发：Broker 接收消息后，将其转发给所有订阅sensors/temp的设备（此处为监控平台）。
5. 确认：监控平台收到消息后，向 Broker 发送PUBACK确认，Broker 停止重传该消息。
6. 断开：设备完成通信后，通过DISCONNECT报文断开连接。

### 五、主流 MQTT Broker

- Broker 是 MQTT 通信的核心，负责消息转发、连接管理等，主流实现包括：
- Eclipse Mosquitto：轻量级开源 Broker，支持 MQTT 3.1.1 和 5.0，适合小型场景。
- EMQX：高性能开源 Broker，支持百万级并发连接，提供集群、监控等企业级功能。
- AWS IoT Core / Azure IoT Hub：云厂商提供的托管 MQTT 服务，集成云平台生态。
- Apache Kafka：高吞吐量的分布式流处理平台，支持 MQTT 协议，适用于大规模数据处理。
- HiveMQ：企业级 MQTT Broker，提供安全、可靠的消息传递，支持 MQTT 5.0。
- RabbitMQ：通过插件支持 MQTT，适合已有 RabbitMQ 集群的场景。

### 六、应用场景

- 物联网（IoT）：传感器数据上报（温湿度、气压）、设备远程控制（开关灯、调节阀门）。
- 工业监控：生产线设备状态监控、PLC 与云端数据交互。
- 智能家居：灯光、空调、窗帘等设备间联动（如 “门锁打开→开灯”）。
- 车联网：车辆状态（速度、油量）实时上传，云端指令下发（远程解锁）。

#### MQTT 凭借轻量、低耗、灵活的特性，成为物联网通信的事实标准。其发布 / 订阅模式和解耦设计，完美适配了分布式设备通信的需求，而 QoS、主题、遗嘱消息等机制则确保了在复杂网络环境下的可靠性和灵活性
